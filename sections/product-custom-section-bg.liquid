{% render 'entry' with '@/styles/sections/products-section.scss' %}

{% assign sectionText1 = section.settings.section_text_1 %}
{% assign sectionText2 = section.settings.section_text_2 %}
{% assign sectionSubtitle = section.settings.subtitle %}
{% assign sectionBadgeText = section.settings.section_badge_text %}
{% assign sectionButtonText = section.settings.section_button_text %}

{% assign flow_on  = section.settings.flow_bg_enabled %}
{% assign flow_img = section.settings.flow_bg_image %}
{% if flow_img %}
  {% assign flow_url = flow_img | image_url: width: 2560 %}
{% endif %}

<section
  id="productSection-{{ section.id }}"
  class="products-section products-section-bg mx-auto md:py-[120px] py-[60px] flow-bg anim-slide-in-bottom"
  {% if flow_on and flow_img %} data-image="{{ flow_url }}"{% endif %}
>
  <div class="container">
    <div class="products-section__header grid grid-cols-1 gap-[24px] mb-[50px]">
      {% if section.settings.title != blank %}
        <div class="products-section__header--title products-section__header--title-bg">
          <h2 class="products-section__title heading-3" data-anim="split-text-reveal">
            {{ section.settings.title | default: "Products" }}
          </h2>
          {% if sectionSubtitle != blank %}
            <p class="products-section__subtitle" data-anim="fade-in-slide-up">
              {{ sectionSubtitle }}
            </p>
          {% endif %}
        </div>
      {% endif %}
    </div>
  </div>

  <div class="slider-wrapper relative">
    <div id="productSection-{{ section.id }}" class="swiper-box">
      {% if section.settings.products_list != blank %}
        {% assign collection = section.settings.products_list %}

        <div class="swiper-button-next md:block" data-anim="fade-in-slide-up">
          <svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M12.2343 1.08621L11.6871 1.63336C11.5497 1.77077 11.5497 1.99354 11.6871 2.13094L16.8175 7.26112H0.851838C0.657523 7.26112 0.5 7.41864 0.5 7.61296V8.38692C0.5 8.58123 0.657523 8.73876 0.851838 8.73876H16.8175L11.6871 13.8691C11.5497 14.0065 11.5497 14.2293 11.6871 14.3667L12.2343 14.9138C12.3717 15.0512 12.5944 15.0512 12.7318 14.9138L19.3969 8.24873C19.5344 8.11133 19.5344 7.88855 19.3969 7.75115L12.7318 1.0862C12.5944 0.948804 12.3717 0.948805 12.2343 1.08621Z" fill="currentColor"></path>
          </svg>
        </div>

        <div class="swiper-button-prev md:block" data-anim="fade-in-slide-up">
          <svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M7.76574 1.08621L8.3129 1.63336C8.4503 1.77077 8.4503 1.99354 8.31289 2.13094L3.18254 7.26112H19.1482C19.3425 7.26112 19.5 7.41864 19.5 7.61296V8.38692C19.5 8.58123 19.3425 8.73876 19.1482 8.73876H3.18254L8.3129 13.8691C8.4503 14.0065 8.4503 14.2293 8.3129 14.3667L7.76574 14.9138C7.62834 15.0512 7.40557 15.0512 7.26817 14.9138L0.603052 8.24873C0.465647 8.11133 0.465649 7.88855 0.603054 7.75115L7.26817 1.0862C7.40557 0.948804 7.62834 0.948805 7.76574 1.08621Z" fill="currentColor"></path>
          </svg>
        </div>

        <div class="container">
          <div id="swiper-container-{{ section.id }}" class="swiper-container !pb-[40px] md:!pb-0" data-anim="fade-in-slide-up">
            <div class="swiper-wrapper">
              {% for item in collection %}
                <div class="swiper-slide">
                  {% render 'product-card', product: item, simple_hover: section.settings.simple_hover %}
                </div>
              {% endfor %}
            </div>
          </div>
          <div class="swiper-pagination h-[2px] bg-white/10 w-full"></div>
        </div>
      {% else %}
        <p class="col-span-full text-center text-gray-600 py-8">No products selected.</p>
      {% endif %}
    </div>
  </div>

  <div class="container" style="margin-top: 100px;">
    <div class="flex justify-center">
      {% if sectionButtonText != blank %}
        <a href="{{ section.settings.section_button_link }}" class="btn btn-light">
          {{ sectionButtonText }}
        </a>
      {% endif %}
    </div>
  </div>
</section>

<style>
  .flow-bg{
    position: relative;
  {% if section.settings.background_image %}
    background-image: url('{{ section.settings.background_image | image_url: width: 2000 }}');
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
  {% else %}
    /* Fallback to gradient background */
    position: relative;
    overflow: hidden;
    background-color: #F3F2F1;
    background-image:
      radial-gradient(38% 40% at 20% 55%, #EBD2DE 0%, rgba(235,210,222,0) 60%),
      radial-gradient(48% 44% at 72% 12%, #C8CEC4 0%, rgba(200,206,196,0) 60%),
      radial-gradient(42% 42% at 86% 86%, #A7C1CD 0%, rgba(167,193,205,0) 58%),
      radial-gradient(120% 120% at 50% 50%, #E2D0D9 0%, rgba(226,208,217,0) 70%);
    background-blend-mode: normal;
    background-size: cover;
  {% endif %}
  }

  {% unless section.settings.background_image %}
  .flow-bg::after{
    content:""; position:absolute; inset:-12%; pointer-events:none; z-index:0;
    background:
      radial-gradient(46% 46% at 24% 58%, rgba(235,210,222,0.6) 0%, rgba(235,210,222,0) 65%),
      radial-gradient(60% 60% at 78% 18%, rgba(200,206,196,0.45) 0%, rgba(200,206,196,0) 70%);
    mix-blend-mode: soft-light;
    animation: mesh-drift 10s ease-in-out infinite alternate;
    will-change: transform, opacity;
    opacity: .5;
  }
  @keyframes mesh-drift{
    0%   { transform: translate3d(2%, 2%, 0) scale(1.03); opacity:.46; }
    100% { transform: translate3d(-2%, -2%, 0) scale(1.05); opacity:.58; }
  }
  @media (prefers-reduced-motion: reduce){
    .flow-bg::after{ animation: none; }
  }
  {% endunless %}

  .flow-bg > *{ position: relative; z-index: 1; }
  .shopify-section:has(#productSection-{{ section.id }}) {
    padding-bottom: 0;
  }

  .split-char {
    display: inline-block;
    position: relative;
    transform: translateY(100%);
    opacity: 0;
  }
</style>

<script src="https://cdn.jsdelivr.net/npm/pixi.js@8/dist/pixi.min.js"></script>

<script>
  document.addEventListener('alpine:init', () => {
    Alpine.data('variantSelector', (defaultVariantId) => ({
      selectedVariants: [],
      defaultVariantId,
      updateSelectedVariants(event) {
        const form = this.$el
        const selectedCheckbox = event.target
        form.querySelectorAll('input[type="checkbox"]').forEach(cb => {
          if (cb !== selectedCheckbox) cb.checked = false
        })
        this.selectedVariants = selectedCheckbox.checked ? [selectedCheckbox.value] : []
      },
      addToCart() {
        const variantId = this.selectedVariants.length > 0 ? this.selectedVariants[0] : this.defaultVariantId
        Alpine.store('cart').addToCart({ variantId })
      }
    }))
  })

  document.addEventListener('DOMContentLoaded', () => {
    const sectionSel   = '#productSection-{{ section.id }}'
    const containerSel = '#swiper-container-{{ section.id }}'

    // кількість оригінальних слайдів (до ініта Swiper)
    const originalSlideCount = document.querySelectorAll(
      `${containerSel} .swiper-wrapper > .swiper-slide`
    ).length

    const swiper = new Swiper(containerSel, {
      loop: true,
      slidesPerView: 4,
      spaceBetween: 8,

      navigation: {
        nextEl: `${sectionSel} .swiper-button-next`,
        prevEl: `${sectionSel} .swiper-button-prev`,
        enabled: true
      },

      pagination: {
        el: `${sectionSel} .swiper-pagination`,
        type: 'progressbar',
        enabled: false
      },

      breakpoints: {
        0: {
          slidesPerView: 1,
          centeredSlides: true,
          autoHeight: true,
          // на мобайлі логікою не керуємо — стилями сховаєш стрілки
          navigation: { enabled: false },
          pagination: { enabled: true, type: 'progressbar' }
        },
        768: {
          slidesPerView: 3,
          autoHeight: true,
          navigation: { enabled: true },
          pagination: { enabled: true, type: 'progressbar' }
        },
        1024: {
          slidesPerView: 4,
          autoHeight: true,
          navigation: { enabled: true },
          pagination: { enabled: true, type: 'progressbar' }
        }
      }
    })

    const nextBtn   = document.querySelector(`${sectionSel} .swiper-button-next`)
    const prevBtn   = document.querySelector(`${sectionSel} .swiper-button-prev`)
    const mqDesktop = window.matchMedia('(min-width: 1024px)')

    const setDisplay = (el, show) => {
      if (!el) return
      el.style.display = show ? '' : 'none'
    }

    function updateNavVisibility() {
      const isDesktop = mqDesktop.matches

      // лише десктоп: якщо < 5 слайдів — ховаємо та вимикаємо навігацію
      if (isDesktop && originalSlideCount < 5) {
        swiper.navigation?.disable?.()
        setDisplay(nextBtn, false)
        setDisplay(prevBtn, false)
      } else if (isDesktop) {
        swiper.navigation?.enable?.()
        setDisplay(nextBtn, true)
        setDisplay(prevBtn, true)
      } else {
        // не десктоп — нічого не робимо; видимість керується CSS
      }
    }

    swiper.on('breakpoint', updateNavVisibility)
    swiper.on('resize', updateNavVisibility)
    updateNavVisibility()
  })
</script>

{% schema %}
{
  "name": "Products Section Bg",
  "settings": [
    {
      "type": "product_list",
      "id": "products_list",
      "label": "Products"
    },
    {
      "type": "checkbox",
      "id": "simple_hover",
      "label": "Hover effect for product card simplified",
      "default": false
    },
    {
      "type": "richtext",
      "id": "title",
      "label": "Section Title",
    },
    {
      "type": "richtext",
      "id": "subtitle",
      "label": "Section subtitle",
    },
    {
      "type": "richtext",
      "id": "section_text_1",
      "label": "Section text 1",
    },
    {
      "type": "textarea",
      "id": "section_badge_icon",
      "label": "Paste icon for badge",
    },
    {
      "type": "text",
      "id": "section_badge_text",
      "label": "Section badge text",
    },
    {
      "type": "richtext",
      "id": "section_text_2",
      "label": "Section text 2"
    },
    {
      "type": "text",
      "label": "Button Text",
      "id": "section_button_text",
      "default": "Shop Now"
    },
    {
      "type": "url",
      "label": "Button Link",
      "id": "section_button_link"
    },
    {
      "type": "header",
      "content": "Background Settings"
    },
    {
      "type": "image_picker",
      "id": "background_image",
      "label": "Background Image",
      "info": "Upload your background image here (replaces gradient)"
    },
    {
      "type": "header",
      "content": "Flow background"
    },
    {
      "type": "checkbox",
      "id": "flow_bg_enabled",
      "label": "Enable flow background",
      "default": true
    },
    {
      "type": "image_picker",
      "id": "flow_bg_image",
      "label": "Background image"
    }
  ],
  "presets": [
    {
      "name": "Products Section Bg"
    }
  ]
}
{% endschema %}
