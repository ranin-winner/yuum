{"version":3,"file":"main-product-CrbXoggx.js","sources":["../frontend/scripts/sections/main-product.js"],"sourcesContent":["document.addEventListener('alpine:init', () => {\n    Alpine.data('productCard', (sectionId, product) => ({\n  \n      // ---------- STATE ----------\n      sectionId,\n      mainProduct: product || {},\n  \n      mode: 'one-time',\n      showSubscription: false,\n  \n      discount: 0,\n      regularPrice: 0,\n      discountedPrice: 0,\n      actualPrice: 0,\n  \n      sellingPlanGroups: undefined,\n      sellingPlanId: null,\n      sellingPlansMap: [],\n      selectedPlanId: null,\n      selectedPlan: {},\n  \n      isLoading: false,\n      sliderLoading: false,\n      swiper: null,\n  \n      // ---------- LIFECYCLE ----------\n      init() {\n        try { this.bootstrapModeFromDOM(); } catch(e) { /* noop */ }\n        try { this.updateActualPrice(); } catch(e) { /* noop */ }\n  \n        // важливо інітити після першого рендера\n        this.$nextTick(() => this.initProductSwiper());\n      },\n  \n      destroy() {\n        this.destroyProductSwiper();\n      },\n  \n      // ---------- HELPERS ----------\n      // Працюємо тільки всередині поточного Alpine-компонента\n      $q(selector) { return this.$root ? this.$root.querySelector(selector) : null; }\n      ,\n  \n      getSliderWrapper() {\n        return this.$q('[data-role=\"main-product-slider\"]');\n      },\n  \n      // ---------- SWIPER ----------\n      initProductSwiper() {\n        try {\n          this.destroyProductSwiper();\n  \n          const wrapper = this.getSliderWrapper();\n          if (!wrapper) return;\n          if (!window.Swiper) { console.error('[productCard] Swiper is not available'); return; }\n  \n          const container  = wrapper.querySelector('[data-el=\"container\"]');\n          const nextEl     = wrapper.querySelector('[data-el=\"next\"]');\n          const prevEl     = wrapper.querySelector('[data-el=\"prev\"]');\n          const pagination = wrapper.querySelector('[data-el=\"pagination\"]');\n  \n          if (!container) return;\n  \n          // Підтримка і старої, і нової розмітки (на всяк випадок)\n          // Якщо контейнер має клас .swiper-container — додамо .swiper для стилів Swiper v8+\n          if (container.classList.contains('swiper-container')) {\n            container.classList.add('swiper');\n          }\n  \n          this.swiper = new window.Swiper(container, {\n            slidesPerView: 1,\n            spaceBetween: 0,\n            loop: false,\n            watchOverflow: true,\n  \n            navigation: { nextEl, prevEl },\n            pagination: { el: pagination, clickable: true },\n  \n            observer: true,\n            observeParents: true,\n          });\n        } catch (e) {\n          console.error('[productCard] initProductSwiper failed:', e);\n        }\n      },\n  \n      destroyProductSwiper() {\n        try {\n          if (this.swiper && typeof this.swiper.destroy === 'function') {\n            this.swiper.destroy(true, true);\n          }\n        } finally {\n          this.swiper = null;\n        }\n      },\n  \n      // ---------- AJAX ПІДМІНА СЕКЦІЇ ----------\n      loadProduct(productHandle) {\n        if (!productHandle) return;\n  \n        const sectionUrl = `/products/${productHandle}?sections=${this.sectionId}`;\n        const jsonUrl    = `/products/${productHandle}.js`;\n  \n        this.isLoading = true;\n  \n        fetch(sectionUrl)\n          .then((r) => { if (!r.ok) throw new Error('[productCard] Section fetch failed'); return r.json(); })\n          .then((payload) => {\n            const html = payload?.[this.sectionId];\n            if (!html) throw new Error('[productCard] Section HTML not found');\n  \n            const tmp = document.createElement('div');\n            tmp.innerHTML = html;\n  \n            // Важливо: знайди новий корінь секції саме всередині $root-контексту\n            const fresh = tmp.querySelector('#MainProduct-' + this.sectionId);\n            if (fresh && this.$refs.productCardRef) {\n              this.$refs.productCardRef.replaceWith(fresh);\n              // Оновлюємо $root посилання на новий DOM вузол\n              this.$root = fresh;\n              this.$nextTick(() => this.initProductSwiper());\n            }\n  \n            return fetch(jsonUrl);\n          })\n          .then((r) => { if (!r?.ok) throw new Error('[productCard] Product JSON fetch failed'); return r.json(); })\n          .then((productData) => {\n            this.initNewProduct(productData);\n            window.history.pushState({ urlPath: productHandle }, '', productHandle);\n          })\n          .catch((e) => console.error(e))\n          .finally(() => { this.isLoading = false; });\n      },\n  \n      initNewProduct(productData) {\n        if (!productData || !productData.id) return;\n        this.mainProduct = productData;\n        this.updateActualPrice();\n        this.$nextTick(() => this.initProductSwiper());\n      },\n  \n      // ---------- ВАРІАНТИ/ЦІНИ ----------\n      updateActualPrice() {\n        const variant = this.getSelectedVariant();\n        if (!variant) return;\n  \n        this.regularPrice    = Number(variant.compare_at_price || variant.price || 0);\n        this.discountedPrice = Number(variant.price || 0);\n  \n        if (this.showSubscription && this.selectedPlan && this.selectedPlan.discount) {\n          const pct = Number(this.selectedPlan.discount) || 0;\n          this.actualPrice = Math.round(this.discountedPrice * (1 - pct / 100));\n        } else {\n          this.actualPrice = this.discountedPrice;\n        }\n      },\n  \n      getSelectedVariant() {\n        const variants = this.mainProduct?.variants || [];\n        if (!variants.length) return null;\n  \n        const input = document.querySelector(\n          '[name=\"id\"][type=\"hidden\"], [name=\"id\"][type=\"radio\"]:checked'\n        );\n        if (input && input.value) {\n          const found = variants.find(v => String(v.id) === String(input.value));\n          if (found) return found;\n        }\n        const fav = variants.find(v => v.available);\n        return fav || variants[0];\n      },\n  \n      onVariantChange() {\n        try { this.updateActualPrice(); } catch(e) { /* noop */ }\n      },\n  \n      // ---------- ПІДПИСКА ----------\n      bootstrapModeFromDOM() {\n        const el = document.querySelector('[data-subscription-tabs]');\n        if (!el) { this.mode = 'one-time'; this.showSubscription = false; return; }\n  \n        const t1 = el.getAttribute('data-tab1-selected');\n        const t2 = el.getAttribute('data-tab2-selected');\n        const m  = el.getAttribute('data-tab-selected');\n  \n        if (t1 != null) this.tab1Selected = JSON.parse(t1);\n        if (t2 != null) this.tab2Selected = JSON.parse(t2);\n        if (m) this.mode = m;\n  \n        this.showSubscription = this.mode === 'subscribe';\n      },\n  \n      selectPlan(planId) {\n        this.selectedPlanId = planId || null;\n        this.selectedPlan = (this.sellingPlansMap || []).find(p => String(p.id) === String(planId)) || {};\n        this.showSubscription = !!this.selectedPlanId;\n        this.updateActualPrice();\n      },\n  \n      toggleSubscription(force) {\n        if (typeof force === 'boolean') this.showSubscription = force;\n        else this.showSubscription = !this.showSubscription;\n        this.updateActualPrice();\n      },\n    }));\n  });\n  "],"names":["sectionId","product","selector","wrapper","container","nextEl","prevEl","pagination","e","productHandle","sectionUrl","jsonUrl","r","payload","html","tmp","fresh","productData","variant","pct","_a","variants","input","found","v","el","t1","t2","m","planId","p","force"],"mappings":"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"}