<section
  class="b-mini_cart"
  x-cloak
  :class="$store.cart.isCartOpen ? 'is-open' : 'is-closed'"
  @click.outside="$store.cart.toggleCart(false)">
  <div class="b-mini_cart__inner">
    <span class="b-mini_cart-close" @click="$store.cart.toggleCart()">
      <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" class="icon icon-close" fill="currentColor" viewBox="0 0 18 17">
        <path d="M.865 15.978a.5.5 0 00.707.707l7.433-7.431 7.579 7.282a.501.501 0 00.846-.37.5.5 0 00-.153-.351L9.712 8.546l7.417-7.416a.5.5 0 10-.707-.708L8.991 7.853 1.413.573a.5.5 0 10-.693.72l7.563 7.268-7.418 7.417z" fill="currentColor"></path>
      </svg>
    </span>

    <div class="b-mini_cart-header">
      <h3 class="b-mini_cart-title">
        Shopping cart <span x-text="'(' + ($store.cart.itemsCount || 0) + ')'" class="b-mini_cart-count"></span>
      </h3>
    </div>

    <!-- Delivery message -->
    <div class="b-mini_cart-shipping" x-show="$store.cart.items.length > 0">
      <p class="b-mini_cart-shipping__text">
        Spend <span class="b-mini_cart-shipping__amount" x-text="'{{ cart.currency.symbol }}' + ($store.cart.remainingForFreeShipping || 0)"></span> more to get free mainland UK delivery
      </p>
    </div>

    <!-- Empty cart message -->
    <div class="b-mini_cart-shipping" x-show="$store.cart.items.length === 0">
      <p class="b-mini_cart-shipping__text">
        FREE mainland UK delivery for orders over Â£50
      </p>
    </div>

    <!-- Empty cart -->
    <div class="b-mini_cart-empty" x-show="$store.cart.items.length === 0">
      <h2 class="b-mini_cart-empty__title">Your cart is currently empty</h2>
      <button class="b-mini_cart-continue">CONTINUE SHOPPING</button>
    </div>

    <div class="b-mini_cart-content" x-show="$store.cart.items.length > 0">

      <div class="b-mini_cart-columns"></div>

      <div class="b-mini_cart-items">
        <template x-for="(item, index) in $store.cart.items" :key="`${item.id}-${index}`">
          <div class="b-mini_cart-items-border">
            <div class="b-mini_cart-item">
                <div class="b-mini_cart-item__left-section">
                  <figure class="b-mini_cart-item__image">
                    <img :src="item.image" :alt="item.title">
                  </figure>

                  <div class="b-quantity">
                    <button class="b-quantity__btn b-quantity__btn--minus"
                            @click="$store.cart.decrementQuantity(item.id, item.quantity)">-</button>
                    <div class="b-quantity__value" x-text="item.quantity"></div>
                    <button class="b-quantity__btn b-quantity__btn--plus"
                            @click="$store.cart.updateCart(item.id, (item.quantity || 1) + 1)">+</button>
                  </div>
                </div>

                <div class="b-mini_cart-item__right-section">
                  <div class="b-mini_cart-item__main-info">
                    <div class="b-mini_cart-item__text-content">
                      <h4 class="b-mini_cart-item__name" x-html="item.product_title || item.title"></h4>
                      <p class="b-mini_cart-item__variant"
                         x-text="item.variant_title && item.variant_title !== 'Default Title' ? item.variant_title : (item.grams ? item.grams + 'g' : '')">
                      </p>
                      <p class="b-mini_cart-item__price">
                  <span
                    class="b-mini_cart-item__compare-price"
                    x-show="(item.compare_at_price || item.final_compare_at_price || 0) > (item.price || item.final_price || 0)"
                    x-text="'{{ cart.currency.symbol }}' + (((item.compare_at_price ?? item.final_compare_at_price ?? 0) / 100).toFixed(2))">
                  </span>
                        <span x-text="'{{ cart.currency.symbol }}' + (((item.final_price ?? item.price ?? 0) / 100).toFixed(2))"></span>
                      </p>
                    </div>

                    <div class="b-mini_cart-item__total">
                <span
                  class="b-mini_cart-item__total-compare"
                  x-show="(item.compare_at_price || item.final_compare_at_price || 0) > (item.price || item.final_price || 0)"
                  x-text="'{{ cart.currency.symbol }}' + ((((item.compare_at_price ?? item.final_compare_at_price ?? 0) / 100) * (item.quantity || 1)).toFixed(2))">
                </span>
                      <span class="b-mini_cart-item__total-price"
                            x-text="'{{ cart.currency.symbol }}' + ((((item.final_price ?? item.price ?? 0) / 100) * (item.quantity || 1)).toFixed(2))"></span>
                    </div>
                  </div>

                  <div class="b-mini_cart-item__bottom-controls">
                    <button class="b-mini_cart-item__remove"
                            @click="$store.cart.removeFromCart(item.key)">Remove</button>
                  </div>
                </div>
            </div>
          </div>
        </template>
      </div>
    </div>

    <!-- Recommendations -->
    {% if settings.show_cart_products_carousel %}
      <div class="b-mini_cart-recommendations">
        <div class="b-mini_cart-recommendations__header">
          <h4 class="b-mini_cart-recommendations__title">WE RECOMMEND</h4>
          <div class="b-mini_cart-recommendations__controls">
            <button class="b-mini_cart-recommendations__arrow b-mini_cart-recommendations__arrow--prev">
              <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                <path d="M6.21416 2.46892L6.65188 2.90664C6.7618 3.01656 6.7618 3.19478 6.65188 3.3047L2.5476 7.40885H15.3201C15.4755 7.40885 15.6016 7.53487 15.6016 7.69032V8.30948C15.6016 8.46494 15.4755 8.59096 15.3201 8.59096H2.5476L6.65189 12.6952C6.76181 12.8052 6.76181 12.9834 6.65189 13.0933L6.21416 13.531C6.10424 13.641 5.92602 13.641 5.8161 13.531L0.484004 8.19893C0.374082 8.08901 0.374083 7.91079 0.484007 7.80087L5.8161 2.46891C5.92602 2.35899 6.10424 2.359 6.21416 2.46892Z"/>
              </svg>
            </button>
            <button class="b-mini_cart-recommendations__arrow b-mini_cart-recommendations__arrow--next">
              <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                <path d="M9.78584 2.46892L9.34812 2.90664C9.2382 3.01656 9.2382 3.19478 9.34812 3.3047L13.4524 7.40885H0.679885C0.52443 7.40885 0.398407 7.53487 0.398407 7.69032V8.30948C0.398407 8.46494 0.52443 8.59096 0.679885 8.59096H13.4524L9.34811 12.6952C9.23819 12.8052 9.23819 12.9834 9.34811 13.0933L9.78584 13.531C9.89576 13.641 10.074 13.641 10.1839 13.531L15.516 8.19893C15.6259 8.08901 15.6259 7.91079 15.516 7.80087L10.1839 2.46891C10.074 2.35899 9.89576 2.359 9.78584 2.46892Z"/>
              </svg>
            </button>
          </div>
        </div>

        <div class="b-mini_cart-recommendations__slider swiper-container">
          <div class="swiper-wrapper">
            {% for product_item in settings.cart_products %}
              {% assign productMeta = product_item.metafields.custom %}
              <div class="swiper-slide">
                <div class="b-recommendation-item">
                  <figure class="b-recommendation-item__image">
                    <img src="{{ product_item.featured_image | img_url: '80x80' }}" alt="{{ product_item.title }}">
                  </figure>
                  <div class="b-recommendation-item__content">
                    <h5 class="b-recommendation-item__name">{{ product_item.title }}</h5>
                    <p class="b-recommendation-item__variant">{{ productMeta.subtitle | default: '40g' }}</p>
                    <div class="b-recommendation-item__bottom">
                      <span class="b-recommendation-item__price">{{ product_item.price | money }}</span>
                      <button class="b-recommendation-item__add desktop-add"
                              data-product-id="{{ product_item.first_available_variant.id }}"
                              @click="$store.cart.addToCart({ variantId: $el.dataset.productId, quantity: 1 }, false)">
                        ADD
                      </button>
                      <button class="b-recommendation-item__add mobile-add"
                              data-product-id="{{ product_item.first_available_variant.id }}"
                              @click="$store.cart.addToCart({ variantId: $el.dataset.productId, quantity: 1 }, false)">
                        +
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            {% endfor %}
          </div>

          <!-- Slider progress bar -->
          <div class="b-mini_cart-carousel__progress swiper-pagination"></div>
        </div>
      </div>

      <!-- JavaScript for slider initialization -->
      <script>
        document.addEventListener('DOMContentLoaded', function() {
          var swiper = new Swiper('.b-mini_cart-recommendations__slider', {
            slidesPerView: 1,
            spaceBetween: 8,
            loop: true,
            autoplay: {
              delay: 5000,
              disableOnInteraction: false,
            },
            navigation: {
              nextEl: '.b-mini_cart-recommendations__arrow--next',
              prevEl: '.b-mini_cart-recommendations__arrow--prev',
            },
            pagination: {
              el: '.b-mini_cart-recommendations .swiper-pagination',
              type: 'progressbar',
            },
            breakpoints: {
              768: {
                slidesPerView: 1,
                spaceBetween: 12,
              }
            }
          });
        });
      </script>
    {% endif %}

    <!-- Total -->
    <div class="b-mini_cart-total" x-show="$store.cart.items.length > 0">
      <div class="b-mini_cart-total__row">
        <span class="b-mini_cart-total__label">Subtotal</span>
        <span class="b-mini_cart-total__value" x-text="'{{ cart.currency.symbol }}' + $store.cart.totalPrice"></span>
      </div>
      <button class="b-mini_cart-checkout" @click="window.location.href='/checkout'">
        GO TO CHECKOUT
      </button>
      <p class="b-mini_cart-tax">Tax included. Shipping calculated at checkout.</p>
    </div>
  </div>
</section>
