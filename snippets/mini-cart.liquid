<section
  class="b-mini_cart"
  x-cloak
  :class="$store.cart.isCartOpen ? 'is-open' : 'is-closed'"
  @click.outside="$store.cart.toggleCart(false)">
  <div class="p-5 h-full flex flex-col">
    <span class="b-mini_cart-close text-color_1" @click="$store.cart.toggleCart()">
      <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" class="icon icon-close" fill="currentColor" viewBox="0 0 18 17">
        <path d="M.865 15.978a.5.5 0 00.707.707l7.433-7.431 7.579 7.282a.501.501 0 00.846-.37.5.5 0 00-.153-.351L9.712 8.546l7.417-7.416a.5.5 0 10-.707-.708L8.991 7.853 1.413.573a.5.5 0 10-.693.72l7.563 7.268-7.418 7.417z" fill="currentColor"></path>
      </svg>
    </span>

    <div class="b-mini_cart-header py-5">
      <h3 class="b-mini_cart-title text-xl font-Gazpacho">Your Cart</h3>
    </div>

    <div class="drawer__header-row progress-bar-row" x-show="$store.cart.items.length > 0">
      {% render 'progress-bar' data: 'cart' %}
    </div>

    <div class="b-mini_cart-empty flex grow justify-center items-center" x-show="$store.cart.items.length === 0">
      <h2 class="text-center">Your cart is empty</h2>
    </div>

    <div
      class="b-mini_cart-list flex flex-col gap-6 grow max-h-[70vh] overflow-y-auto"
      x-show="$store.cart.items.length > 0"
      :class="$store.cart.isLoading ? 'm-loading' : ''">
      <div class="flex justify-between uppercase opacity-50 border-b pb-4 text-xs font-Aksen font-normal tracking-wide">
        <span>Product</span>
        <span>Total</span>
      </div>

      <template x-for="(item, index) in $store.cart.items" :key="`${item.id}-${index}`">
        <div class="b-mini_cart-item">
          <figure class="w-[100px] h-[100px] shrink-0 relative rounded-xl overflow-hidden">
            <img :src="item.image" class="bg-white absolute left-0 top-0 h-full w-full object-cover" width="40" height="40">
          </figure>

          <div class="b-mini_cart-item__desc">
            <div class="mb-4">
              <h4 x-html="item.title" class="w-full mb-4 pr-24 font-Gazpacho"></h4>

              <p class="mt-2 text-sm font-Aksen font-normal">
                <!-- Перекреслена (порівняльна) ціна для звичайних товарів -->
                <span
                  class="line-through opacity-50"
                  x-show="(item.compare_at_price || item.final_compare_at_price || 0) > (item.price || item.final_price || 0)"
                  x-text="'{{ cart.currency.symbol }}' + (((item.compare_at_price ?? item.final_compare_at_price ?? 0) / 100).toFixed(2))">
                </span>

                <!-- Поточна ціна -->
                <span
                  x-text="'{{ cart.currency.symbol }}' + (((item.final_price ?? item.price ?? 0) / 100).toFixed(2))">
                </span>
              </p>
            </div>

            <div class="absolute right-4 top-4 flex flex-col font-Aksen font-normal">
              <!-- Загальна перекреслена сума (qty) -->
              <span
                x-show="(item.compare_at_price || item.final_compare_at_price || 0) > (item.price || item.final_price || 0)"
                class="line-through opacity-50"
                x-text="'{{ cart.currency.symbol }}' + ((((item.compare_at_price ?? item.final_compare_at_price ?? 0) / 100) * (item.quantity || 1)).toFixed(2))">
              </span>

              <!-- Загальна сума (qty) -->
              <span
                x-text="'{{ cart.currency.symbol }}' + ((((item.final_price ?? item.price ?? 0) / 100) * (item.quantity || 1)).toFixed(2))">
              </span>
            </div>

            <div class="flex">
              <div class="b-quantity !border-black mr-4">
                <span
                  @click="$store.cart.decrementQuantity(item.id, item.quantity)"
                  class="b-quantity-sign m-minus !text-black-content">-</span>

                <div x-text="item.quantity" class="b-quantity-input !text-black-content"></div>

                <span
                  @click="$store.cart.updateCart(item.id, (item.quantity || 1) + 1)"
                  class="b-quantity-sign m-plus !text-black-content">+</span>
              </div>

              <button @click="$store.cart.removeFromCart(item.key)" class="text-color_4">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" aria-hidden="true" focusable="false" class="icon m-small icon-remove">
                  <path d="M14 3h-3.53a3.07 3.07 0 00-.6-1.65C9.44.82 8.8.5 8 .5s-1.44.32-1.87.85A3.06 3.06 0 005.53 3H2a.5.5 0 000 1h1.25v10c0 .28.22.5.5.5h8.5a.5.5 0 00.5-.5V4H14a.5.5 0 000-1zM6.91 1.98c.23-.29.58-.48 1.09-.48s.85.19 1.09.48c.2.24.3.6.36 1.02h-2.9c.05-.42.17-.78.36-1.02zm4.84 11.52h-7.5V4h7.5v9.5z" fill="currentColor"></path>
                  <path d="M6.55 5.25a.5.5 0 00-.5.5v6a.5.5 0 001 0v-6a.5.5 0 00-.5-.5zM9.45 5.25a.5.5 0 00-.5.5v6a.5.5 0 001 0v-6a.5.5 0 00-.5-.5z" fill="currentColor"></path>
                </svg>
              </button>
            </div>
          </div>
        </div>
      </template>
    </div>

    {% if settings.show_cart_products_carousel %}
      <div class="b-mini_cart-carousel">
        <!-- Заголовок з назвою та стрілками -->
        <div class="b-mini_cart-carousel__header">
          <h4>WE RECOMMEND</h4>
          <div class="b-mini_cart-carousel__controls">
            <!-- Ліва стрілка з дизайну -->
            <div id="prev-swiper" class="swiper-button-prev">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" fill="none">
                <path d="M6.21416 2.46892L6.65188 2.90664C6.7618 3.01656 6.7618 3.19478 6.65188 3.3047L2.5476 7.40885H15.3201C15.4755 7.40885 15.6016 7.53487 15.6016 7.69032V8.30948C15.6016 8.46494 15.4755 8.59096 15.3201 8.59096H2.5476L6.65189 12.6952C6.76181 12.8052 6.76181 12.9834 6.65189 13.0933L6.21416 13.531C6.10424 13.641 5.92602 13.641 5.8161 13.531L0.484004 8.19893C0.374082 8.08901 0.374083 7.91079 0.484007 7.80087L5.8161 2.46891C5.92602 2.35899 6.10424 2.359 6.21416 2.46892Z" fill="currentColor"/>
              </svg>
            </div>
            <!-- Права стрілка (дзеркальна) -->
            <div id="next-swiper" class="swiper-button-next">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" fill="none">
                <path d="M9.78584 2.46892L9.34812 2.90664C9.2382 3.01656 9.2382 3.19478 9.34812 3.3047L13.4524 7.40885H0.679885C0.52443 7.40885 0.398407 7.53487 0.398407 7.69032V8.30948C0.398407 8.46494 0.52443 8.59096 0.679885 8.59096H13.4524L9.34811 12.6952C9.23819 12.8052 9.23819 12.9834 9.34811 13.0933L9.78584 13.531C9.89576 13.641 10.074 13.641 10.1839 13.531L15.516 8.19893C15.6259 8.08901 15.6259 7.91079 15.516 7.80087L10.1839 2.46891C10.074 2.35899 9.89576 2.359 9.78584 2.46892Z" fill="currentColor"/>
              </svg>
            </div>
          </div>
        </div>

        <!-- Контейнер каруселі -->
        <div class="swiper-container">
          <div class="swiper-wrapper">
            {% for product_item in settings.cart_products %}
              {% assign productMeta = product_item.metafields.custom %}
              <div class="swiper-slide">
                <div class="b-cart_item flex w-full">
                  <figure class="w-[100px] h-[100px] shrink-0 relative rounded-xl overflow-hidden">
                    <img
                      src="{{ product_item.featured_image | img_url: '100x100' }}"
                      class="bg-white absolute left-0 top-0 h-full w-full object-cover"
                      width="40"
                      height="40">
                  </figure>
                  <div class="b-cart_item__desc grow pl-4 pt-2">
                    <h4 class="w-full mb-2 font-Gazpacho">{{ product_item.title }}</h4>
                    {% if productMeta.subtitle %}
                      <h5 class="mb-4">{{ productMeta.subtitle }}</h5>
                    {% endif %}
                    <div class="flex justify-between">
                      <span class="text-base grow">{{ product_item.price | money }}</span>
                      <span
                        class="btn btn-primary cursor-pointer"
                        aria-label="Add to cart"
                        data-product-id="{{ product_item.first_available_variant.id }}"
                        @click="$store.cart.addToCart({ variantId: $el.dataset.productId, quantity: 1 }, false)"
                      >Add</span>
                    </div>
                  </div>
                </div>
              </div>
            {% endfor %}
          </div>

          <!-- Прогрес бар внизу під слайдами -->
          <div class="b-mini_cart-carousel__progress swiper-pagination"></div>
        </div>
      </div>
      <script>
        document.addEventListener('DOMContentLoaded', function() {
          var swiper = new Swiper('.b-mini_cart-carousel .swiper-container', {
            slidesPerView: 1,
            spaceBetween: 10,
            loop: true,
            autoplay: { delay: 5000 },
            navigation: {
              nextEl: '.b-mini_cart-carousel #next-swiper',
              prevEl: '.b-mini_cart-carousel #prev-swiper',
            },
            pagination: {
              el: ".b-mini_cart-carousel .swiper-pagination",
              type: "progressbar",
            },
          });
        });
      </script>
    {% endif %}

    <div class="b-mini_cart-total flex flex-wrap justify-between">
      <p class="font-Gazpacho hidden">Total items: <span x-text="$store.cart.itemsCount"></span></p>
      <p class="flex items-center justify-between w-full pt-4 pb-2">
        <span class="font-Gazpacho">Total price:</span>
        <span class="font-cenzo font-bold text-xl text-color_1">
          <span x-text="'{{ cart.currency.symbol }}' + $store.cart.totalPrice"></span>
        </span>
      </p>
      <button @click="window.location.href='/checkout'" class="btn btn-primary min-w-full w-full mt-5">
        Proceed to Checkout
      </button>
    </div>
  </div>
</section>
