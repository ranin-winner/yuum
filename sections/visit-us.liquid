{% render 'entry' with '@/styles/sections/visit-us.scss' %}

<section id="visit-us-{{ section.id }}" class="visit-us anim-slide-in-bottom">
  <div class="container container-full">
    <div class="visit-us__inner grid md:grid-cols-2 gap-8 items-start">

      <div class="visit-us__text-inner">
        {% if section.settings.title != blank %}
          <h1 class="heading-1 mb-[12px]">{{ section.settings.title }}</h1>
        {% endif %}
        {% if section.settings.subtitle != blank %}
          <div class="text-[#474747] mb-[40px]">{{ section.settings.subtitle }}</div>
        {% endif %}

        <div class="max-w-[320px] relative">
          <label for="visit-input-{{ section.id }}" class="sr-only">{{ section.settings.input_label }}</label>
          <input id="visit-input-{{ section.id }}" type="text"
                 placeholder="{{ section.settings.input_placeholder }}"
                 class="mb-[8px] w-full bg-[#E7E7E7] outline-none border-0 border-b border-neutral-400 focus:border-neutral-900 focus:ring-0 py-2 text-[14px] placeholder-neutral-400">

          <ul id="visit-suggestions-{{ section.id }}" class="visit-suggestions absolute z-10 w-full bg-[#F5F5F5] rounded hidden"></ul>

          <button id="visit-confirm-{{ section.id }}" class="btn btn-primary w-full mt-2">{{ section.settings.button_label }}</button>
        </div>
      </div>

      <div class="visit-us__map-inner">
        <div id="mapboxContainer-{{ section.id }}"
             data-token="{{ section.settings.mapbox_public_token }}"
             data-style="{{ section.settings.mapbox_style }}"
             style="width:100%;height:100%;min-height:500px;"></div>
      </div>

    </div>
  </div>
</section>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const mapEl = document.getElementById('mapboxContainer-{{ section.id }}');
  const token = mapEl.dataset.token;
  const style = mapEl.dataset.style || 'mapbox://styles/mapbox/streets-v12';
  const defaultCenter = [
    parseFloat('{{ section.settings.default_lng | default: "-0.1276" }}'),
    parseFloat('{{ section.settings.default_lat | default: "51.5072" }}')
  ];
  const defaultZoom = Number('{{ section.settings.default_zoom | default: 10 }}') || 10;

  const customLocations = [
    {% for block in section.blocks %}
      {
        id: {{ block.id | json }},
        title: {{ block.settings.title | json }},
        address: {{ block.settings.address | json }},
        phone: {{ block.settings.phone | json }},
        hours: {{ block.settings.hours | json }},
        lat: {{ block.settings.lat | json }},
        lng: {{ block.settings.lng | json }}
      }{% unless forloop.last %},{% endunless %}
    {% endfor %}
  ];

  mapboxgl.accessToken = token;
  const map = new mapboxgl.Map({
    container: mapEl,
    style: style,
    center: defaultCenter,
    zoom: defaultZoom
  });
  map.addControl(new mapboxgl.NavigationControl(), 'top-right');

    // üß© –í–∏–º–∏–∫–∞—î–º–æ –ø—Ä–æ–±–ª–µ–º–Ω—ñ –∂–µ—Å—Ç–∏
    map.scrollZoom.disable();       // –∫–æ–ª–µ—Å–æ –º–∏—à—ñ
    map.boxZoom.disable();          // —Ä–∞–º–∫–∞ zoom
    map.dragRotate.disable();       // –æ–±–µ—Ä—Ç–∞–Ω–Ω—è
    map.touchZoomRotate.disable();  // pinch zoom + –æ–±–µ—Ä—Ç–∞–Ω–Ω—è –ø–∞–ª—å—Ü—è–º–∏
    map.doubleClickZoom.disable();  // double tap
    map.dragPan.disable();          // –ø–µ—Ä–µ—Ç—è–≥—É–≤–∞–Ω–Ω—è –∫–∞—Ä—Ç–∏ –ø–∞–ª—å—Ü–µ–º

    // üß© –î–æ–∑–≤–æ–ª—è—î–º–æ –ª–∏—à–µ –∫–ª—ñ–∫ –ø–æ –º–∞—Ä–∫–µ—Ä—É
    map.on('touchstart', (e) => {
    e.preventDefault(); // –±–ª–æ–∫—É—î –∑–∞—Ö–æ–ø–ª–µ–Ω–Ω—è —Ç–∞—á-—Å–≤–∞–π–ø—É –∫–∞—Ä—Ç–æ—é
    }, { passive: false });

  const input = document.getElementById('visit-input-{{ section.id }}');
  const list  = document.getElementById('visit-suggestions-{{ section.id }}');
  const button = document.getElementById('visit-confirm-{{ section.id }}');

  const markersById = new Map();
  let activeSelectionMarker = null;
  let searchMarker = null;
  let controller = null;

  const buildMarkerElement = (titleText) => {
    const markerEl = document.createElement('div');
    markerEl.className = 'yuum-marker';
    markerEl.innerHTML = `
    <div class="yuum-marker__label">${titleText || 'YUUM CAF√â'}</div>
      <div class="yuum-marker__pin">
        <svg width="48" height="48" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
            <rect width="48" height="48" rx="24" fill="#474747"/>
            <path d="M24.001 13.0996C28.8175 13.0996 32.7292 17.0107 32.7295 21.8271C32.7295 24.803 31.3657 27.5004 29.665 29.6826C28.4132 31.2896 27.0004 32.595 25.8975 33.5C25.3469 33.9518 24.8754 34.3025 24.543 34.5391C24.3768 34.6573 24.2453 34.747 24.1562 34.8066C24.1119 34.8363 24.078 34.8585 24.0557 34.873C24.0445 34.8803 24.0356 34.8862 24.0303 34.8896L24.001 34.8994C23.9952 34.8993 23.9853 34.8973 23.9746 34.8906C23.9739 34.8902 23.9726 34.8893 23.9717 34.8887C23.9664 34.8852 23.9581 34.8801 23.9473 34.873C23.9249 34.8585 23.891 34.8363 23.8467 34.8066C23.7577 34.747 23.6261 34.6572 23.46 34.5391C23.1274 34.3026 22.6558 33.9523 22.1055 33.501H22.1064C21.0034 32.594 19.5906 31.2906 18.3389 29.6826H18.3379C16.6373 27.5004 15.2734 24.8031 15.2734 21.8271C15.2737 17.0109 19.1847 13.0999 24.001 13.0996ZM24.001 17.5283C21.6276 17.5286 19.7024 19.4538 19.7021 21.8271C19.7021 24.2003 21.627 26.1287 24.001 26.1289C26.3751 26.1289 28.3008 24.2005 28.3008 21.8271C28.3005 19.4536 26.3746 17.5283 24.001 17.5283Z" stroke="white"/>
        </svg>
      </div>
    `;
    return markerEl;
  };

  const createMarker = (loc, lngLat) => {
    const marker = new mapboxgl.Marker({ element: buildMarkerElement(loc.title), anchor: 'bottom' })
      .setLngLat(lngLat)
      .setPopup(new mapboxgl.Popup({ offset: 35, closeButton: false })
        .setHTML(`
          <div class="yuum-popup">
            <strong>${loc.title || 'YUUM CAF√â'}</strong>
            <p>${loc.hours || ''}</p>
            <p>${loc.phone || ''}</p>
          </div>
        `))
      .addTo(map);

    marker.getElement().addEventListener('click', () => {
      activeSelectionMarker = marker;
    });

    return marker;
  };

  const geocodeLocation = async (query) => {
    const url = `https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(query)}.json?limit=1&country=gb&access_token=${token}`;
    const res = await fetch(url);
    const data = await res.json();
    return data?.features?.[0]?.center;
  };

  const ensureMarkerForLocation = async (loc) => {
    if (markersById.has(loc.id)) return markersById.get(loc.id);

    let lng = parseFloat(loc.lng);
    let lat = parseFloat(loc.lat);

    if (Number.isNaN(lng) || Number.isNaN(lat)) {
      const coords = await geocodeLocation(loc.address);
      if (!coords) return null;
      [lng, lat] = coords;
      loc.lng = lng;
      loc.lat = lat;
    }

    const marker = createMarker(loc, [lng, lat]);
    markersById.set(loc.id, marker);
    return marker;
  };

  const initCustomMarkers = async () => {
    const bounds = new mapboxgl.LngLatBounds();

    for (const loc of customLocations) {
      const marker = await ensureMarkerForLocation(loc);
      if (marker) bounds.extend(marker.getLngLat());
    }

    if (!bounds.isEmpty()) {
      map.fitBounds(bounds, { padding: 60, maxZoom: 14 });
    }
  };

  const buildCustomSuggestionMarkup = (loc) => `
    <li class="p-2 hover:bg-gray-100 cursor-pointer"
        data-type="custom"
        data-id="${loc.id}">
        ${loc.title ? `<strong>${loc.title}</strong><br>` : ''}${loc.address}
    </li>
  `;

  const renderSuggestions = (customItems = [], mapboxItems = []) => {
    if (!customItems.length && !mapboxItems.length) {
      list.innerHTML = '';
      list.classList.add('hidden');
      return;
    }

    const customHtml = customItems.map(buildCustomSuggestionMarkup).join('');
    const mapboxHtml = mapboxItems.map(f => `
      <li class="p-2 hover:bg-gray-100 cursor-pointer"
          data-type="mapbox"
          data-lng="${f.center[0]}"
          data-lat="${f.center[1]}"
          data-name="${f.place_name.replace(/"/g, '&quot;')}">
          ${f.place_name}
      </li>
    `).join('');

    list.innerHTML = customHtml + mapboxHtml;
    list.classList.remove('hidden');
  };

  const filterCustomSuggestions = (query) => {
    if (!query) return customLocations;
    const q = query.toLowerCase();
    return customLocations.filter(loc =>
      (loc.address && loc.address.toLowerCase().includes(q)) ||
      (loc.title && loc.title.toLowerCase().includes(q))
    );
  };

  input.addEventListener('focus', () => {
    const customItems = filterCustomSuggestions(input.value.trim());
    renderSuggestions(customItems);
  });

  input.addEventListener('blur', () => {
    setTimeout(() => list.classList.add('hidden'), 120);
  });

  input.addEventListener('input', async () => {
    const query = input.value.trim();
    const customItems = filterCustomSuggestions(query);

    if (query.length < 3) {
      renderSuggestions(customItems);
      if (controller) controller.abort();
      return;
    }

    if (controller) controller.abort();
    controller = new AbortController();

    const url = `https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(query)}.json`
              + `?autocomplete=true&country=gb&limit=5&access_token=${token}`;

    try {
      const res = await fetch(url, { signal: controller.signal });
      const data = await res.json();
      renderSuggestions(customItems, data.features || []);
    } catch (error) {
      if (error.name === 'AbortError') return;
      console.error('‚ùå Geocoding error:', error);
    }
  });

  list.addEventListener('click', async (e) => {
    const li = e.target.closest('li');
    if (!li) return;

    list.classList.add('hidden');

    if (li.dataset.type === 'custom') {
      const loc = customLocations.find(item => String(item.id) === li.dataset.id);
      if (!loc) return;

      input.value = loc.address;
      const marker = await ensureMarkerForLocation(loc);
      if (!marker) return;

      activeSelectionMarker = marker;
      map.flyTo({ center: marker.getLngLat(), zoom: 13 });
      marker.togglePopup();
      return;
    }

    if (li.dataset.type === 'mapbox') {
      const lng = parseFloat(li.dataset.lng);
      const lat = parseFloat(li.dataset.lat);
      const name = li.dataset.name;

      input.value = name;

      if (searchMarker) searchMarker.remove();
      searchMarker = new mapboxgl.Marker({ element: buildMarkerElement('Found spot'), anchor: 'bottom' })
        .setLngLat([lng, lat])
        .addTo(map);

      activeSelectionMarker = searchMarker;
      map.flyTo({ center: [lng, lat], zoom: 13 });
    }
  });

  button.addEventListener('click', () => {
    if (activeSelectionMarker) {
      activeSelectionMarker.togglePopup();
    } else {
      alert('Please select a location from the list first.');
    }
  });

  initCustomMarkers();
});
</script>

<style>

    .mapboxgl-popup-content {
        padding: 0!important;
        margin-bottom: 16px!important;

    }

    .visit-us__map-inner {
    overflow: visible;
    }

    .mapboxgl-popup-tip:has(~ .mapboxgl-popup-content) {
        display: none!important;
    }
    /* === —Å—Ç–∏–ª—ñ–∑–∞—Ü—ñ—è –º–∞—Ä–∫–µ—Ä–∞ === */
    .yuum-marker {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    transform: translateY(-8px);
    }

    .yuum-marker__label {
    background: #474747;
    color: #fff;
    font-size: 11px;
    font-weight: 600;
    letter-spacing: 0.05em;
    padding: 4px 10px;
    border-radius: 6px;
    margin-bottom: 4px;
    }

    /* === —Å—Ç–∏–ª—ñ–∑–∞—Ü—ñ—è popup === */
    .mapboxgl-popup-content.yuum-popup,
    .yuum-popup {
    background: #474747;
    color: #fff;
    border-radius: 8px;
    padding: 12px 16px;
    font-size: 14px;
    line-height: 1.4;
    }

    .yuum-popup strong {
    display: block;
    font-weight: 600;
    margin-bottom: 6px;
    font-size: 15px;
    }

    .yuum-popup p {
    margin: 3px 0;
    opacity: 0.9;
    }
</style>

{% schema %}
{
  "name": "Visit Us",
  "settings": [
    { "type":"text","id":"title","label":"Title","default":"Visit Us" },
    { "type":"richtext","id":"subtitle","label":"Subtitle","default":"<p>Enter your location and see how to reach us...</p>" },
    { "type":"text","id":"input_label","label":"Input label","default":"Enter Postcode or City" },
    { "type":"text","id":"input_placeholder","label":"Input placeholder","default":"Enter Postcode or City" },
    { "type":"text","id":"button_label","label":"Button label","default":"CONFIRM" },
    { "type":"text","id":"mapbox_public_token","label":"Mapbox public token (pk‚Ä¶)"},
    { "type":"text","id":"mapbox_style","label":"Mapbox style URL","default":"mapbox://styles/mapbox/streets-v12" },
    { "type":"text","id":"default_lat","label":"Default latitude","default":"51.5072" },
    { "type":"text","id":"default_lng","label":"Default longitude","default":"-0.1276" },
    { "type":"range","id":"default_zoom","label":"Default zoom","min":3,"max":16,"step":1,"default":10 },
    { "type":"header","content":"Markers (managed via blocks below)" }
  ],
  "blocks": [
    {
      "type": "location",
      "name": "Location",
      "settings": [
        { "type":"text","id":"title","label":"Location name","default":"YUUM Caf√©" },
        { "type":"text","id":"address","label":"Address","default":"19 Air Street, London W1B 5AG, United Kingdom" },
        { "type":"text","id":"hours","label":"Working hours","default":"Mon‚ÄìSat 8:00‚Äì18:00" },
        { "type":"text","id":"phone","label":"Phone","default":"+44 20 7946 0000" },
        { "type":"text","id":"lat","label":"Latitude (optional)","info":"If empty, the address will be geocoded automatically." },
        { "type":"text","id":"lng","label":"Longitude (optional)","info":"If empty, the address will be geocoded automatically." }
      ]
    }
  ],
  "presets":[
    {
      "name":"Visit Us",
      "category":"Contact",
      "blocks":[
        { "type":"location","settings":{"title":"YUUM Caf√©","address":"19 Air Street, London W1B 5AG, United Kingdom","hours":"Mon‚ÄìSat 8:00‚Äì18:00","phone":"+44 20 7946 0000"} },
        { "type":"location","settings":{"title":"YUUM Soho","address":"43 Carnaby St, London W1F 7EA, United Kingdom","hours":"Daily 9:00‚Äì19:00","phone":"+44 20 7946 0001"} },
        { "type":"location","settings":{"title":"YUUM Shoreditch","address":"3 Holywell Ln, London EC2A 3ET, United Kingdom","hours":"Mon‚ÄìFri 7:30‚Äì17:30","phone":"+44 20 7946 0002"} }
      ]
    }
  ]
}
{% endschema %}
