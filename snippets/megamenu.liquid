{%- comment -%}
  Snippet: megamenu.liquid
  Вхід:
    - link           : LinkDrop поточного пункту меню
    - dropdown_index : 1..N (порядковий номер дропдауна)
    - mm_block       : (необов'язково) блок із секції-хедера з полями:
                       .settings.enable (checkbox)
                       .settings.product (product)
                       .settings.categories_heading (text)
                       .settings.collections (collection_list)
                       .settings.show_collection_images (checkbox)
  Логіка:
    1) Якщо передано mm_block — беремо product/collections звідти.
    2) Інакше підтягуємо з глобальних settings: mm{idx}_product, mm{idx}_collections, тощо.
{%- endcomment -%}

{%- liquid
  assign idx = dropdown_index | default: 1

  assign has_left = 0
  if link and link.links
    assign has_left = link.links.size
  endif

  assign slot_enable = true
  assign prod_raw    = nil
  assign cats_head   = nil
  assign coll_list   = nil
  assign show_imgs   = nil

  if mm_block
    if mm_block.settings.enable == false
      assign slot_enable = false
    endif
    assign prod_raw  = mm_block.settings.product
    assign cats_head = mm_block.settings.categories_heading
    assign coll_list = mm_block.settings.collections
    assign show_imgs = mm_block.settings.show_collection_images
  endif

  if prod_raw == nil or coll_list == nil or coll_list.size == 0 or cats_head == blank or show_imgs == nil
    assign prod_key      = 'mm' | append: idx | append: '_product'
    assign cats_head_key = 'mm' | append: idx | append: '_categories_heading'
    assign colls_key     = 'mm' | append: idx | append: '_collections'
    assign show_imgs_key = 'mm' | append: idx | append: '_show_collection_images'
    assign enable_key    = 'mm' | append: idx | append: '_enable'

    if settings[enable_key] == false
      assign slot_enable = false
    endif

    if prod_raw == nil
      assign prod_raw = settings[prod_key]
    endif
    if cats_head == blank
      assign cats_head = settings[cats_head_key]
    endif
    if coll_list == nil or coll_list.size == 0
      assign coll_list = settings[colls_key]
    endif
    if show_imgs == nil
      assign show_imgs = settings[show_imgs_key]
    endif
  endif

  assign normalized_collections = '' | split: ''

  if coll_list and coll_list.size > 0
    for c in coll_list
      assign co = nil

      if c.url
        assign co = c

      elsif c.handle
        assign co = collections[c.handle]

      else
        assign h = c | append: '' | strip
        if h contains '/collections/'
          assign h = h | split: '/collections/' | last
          assign h = h | split: '/' | first
          assign h = h | split: '?' | first
          assign h = h | split: '#' | first
          assign h = h | strip
        endif
        if h != '' and collections[h]
          assign co = collections[h]
        endif
      endif

      if co and co.url
        assign normalized_collections = normalized_collections | push: co
      endif
    endfor
  endif

  assign has_colls = normalized_collections.size

  assign p = nil
  if prod_raw != blank
    if prod_raw.handle
      assign p = prod_raw
    else
      assign p = all_products[prod_raw]
    endif
  endif

  assign slot_on = false
  if slot_enable
    if p
      assign slot_on = true
    elsif has_colls > 0
      assign slot_on = true
    endif
  endif
-%}


<div
  class="group"
  x-data="megamenu"
  @resize.debounce.window="handleResize"
  @click.outside="closeMegamenu"
  @keydown.escape.window="closeMegamenu"
  @mouseenter="onEnterRoot"
  @mouseleave="onLeaveRoot"
>
  <!-- Тригер -->
  <button
    type="button"
    @click="toggleMegamenu"
    @mouseenter="onEnterButton"
    @focusin="onEnterButton"
    class="transition-colors duration-300 relative pr-8"
    :aria-expanded="isOpened.toString()"
    aria-haspopup="true"
  >
    <span class="b-header__list-link">{{ link.title }}</span>
    <svg width="12" height="7" viewBox="0 0 12 7" fill="none" xmlns="http://www.w3.org/2000/svg"
         class="absolute top-1/2 -translate-y-[0.2em] right-0 transform transition-transform duration-200"
         :class="{ 'rotate-180': isOpened }">
      <path d="M5.99953 6.20502L0.644531 0.85502L1.35453 0.14502L5.99953 4.79502L10.6445 0.14502L11.3545 0.85502L5.99953 6.20502Z" fill="#474747"/>
    </svg>
  </button>

  <!-- Панель -->
  <div
    class="absolute top-full left-0 w-full min-h-[30vh] overflow-hidden bg-white-bg border-t border-color_1 shadow-lg"
    x-show="isOpened"
    x-cloak
    x-transition:enter="transition ease-out duration-200"
    x-transition:enter-start="opacity-0"
    x-transition:enter-end="opacity-100"
    x-transition:leave="transition ease-in duration-150"
    x-transition:leave-start="opacity-100"
    x-transition:leave-end="opacity-0"
    @mouseenter="onEnterPanel"
    @mouseleave="onLeavePanel"
  >
    <div class="container mx-auto custom-megamenu-padding">
      <div class="grid grid-cols-3 gap-0">

        <!-- 1) Ліва колонка — підменю -->
        <div class="col-span-1 megamenu-list">
          {%- if has_left > 0 -%}
            <ul class="space-y-3">
              {%- for sub in link.links -%}
                <li>
                  <a href="{{ sub.url }}" class="no-underline">
                    {{ sub.title }}
                  </a>
                </li>
              {%- endfor -%}
            </ul>
          {%- endif -%}
        </div>

        <!-- 2) Центр — продукт (опціонально) -->
        <div class="col-span-1">
          {%- if slot_on and p -%}
            {%- if cats_head != blank -%}
              <div class="text-xs uppercase tracking-wide mb-4 opacity-70">{{ cats_head }}</div>
            {%- endif -%}

            {%- assign _var = p.selected_or_first_available_variant | default: p.first_available_variant -%}
            {%- assign _var_id = _var.id | default: p.variants.first.id -%}

            <article
              class="product-card"
              data-hover="simple"
              x-data="productCard({
                variantId: '{{ _var_id }}',
                productUrl: '{{ p.url }}',
                priceCents: {{ p.price | default: 0 }}
              })"
              data-money-format="{{ shop.money_format | escape | strip_newlines }}"
              data-tags="{{ p.tags | join: ' ' | downcase }}"
              style="max-width: 414px;"
            >
              <a class="product-card__link" href="{{ p.url }}" aria-label="{{ p.title | escape }}"></a>

              <div class="product-card__media">
                {%- assign _img = p.featured_media.preview_image | default: p.featured_image -%}
                {%- render 'image',
                  image: _img,
                  class: 'product-card__img',
                  placeholder: 'image',
                  lazyload: true,
                  fetchpriority: 'auto',
                  alt: p.title,
                  decoding: 'async'
                -%}
              </div>

              <div class="product-card__content">
                <h3 class="product-card__title md:text-[18px] text-[16px] font-normal">
                  <a href="{{ p.url }}">{{ p.title }}</a>
                </h3>
                <p class="product-card__price">
                  {%- if p.compare_at_price and p.compare_at_price > p.price -%}
                    <span class="opacity-60 line-through mr-2">{{ p.compare_at_price | money }}</span>
                  {%- endif -%}
                  {{ p.price | money }}
                </p>
              </div>
            </article>
          {%- endif -%}
        </div>

        <!-- 3) Права колонка — СПИСОК КОЛЕКЦІЙ -->
        <div class="col-span-1 custom-margin">
          {%- if coll_list and coll_list.size > 0 -%}
            {%- if cats_head != blank -%}
              <div class="text-xs uppercase tracking-wide mb-4 opacity-70">{{ cats_head }}</div>
            {%- endif -%}

            <div class="space-y-5 megamenu-list-right">
              {%- for c in coll_list -%}
                {%- liquid
                  assign _co = nil

                  if c.url
                    assign _co = c
                  elsif c.handle
                    assign _co = collections[c.handle]
                  else
                    assign h = c | strip
                    if h contains '/collections/'
                      assign h = h | split: '/collections/' | last
                      assign h = h | split: '/' | first
                      assign h = h | split: '?' | first
                      assign h = h | split: '#' | first
                      assign h = h | strip
                    endif
                    if h != '' and collections[h]
                      assign _co = collections[h]
                    endif
                  endif
                -%}

                {%- if _co and _co.url -%}
                  <div class="group/item menu-collection">
                    <div class="flex items-start gap-[24px] no-underline">
                      {%- assign _img = _co.image -%}
                      {%- if _img == blank and _co.featured_image -%}
                        {%- assign _img = _co.featured_image -%}
                      {%- endif -%}
                      {%- if _img -%}
                        <div class="menu-collection_image flex-shrink-0">
                          <img
                            src="{{ _img | image_url: width: 160, height: 160, crop: 'center' }}"
                            alt="{{ _co.title | escape }}"
                            class="w-full h-full object-cover"
                            loading="lazy">
                        </div>
                      {%- endif -%}
                      <div class="menu-collection_description min-w-0 flex-1">
                        <span class="block text-sm whitespace-nowrap">{{ _co.title }}</span>
                        {%- if _co.description != blank -%}
                          <div class="menu-collection_description-text">
                            {{ _co.description | strip_html | truncate: 60 }}
                          </div>
                        {%- endif -%}

                        <a href="{{ _co.url }}" class="link">
                          Shop now
                        </a>
                      </div>
                    </div>
                  </div>
                {%- endif -%}
              {%- endfor -%}
            </div>

          {%- endif -%}
        </div>

      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('alpine:init', () => {
    Alpine.data('megamenu', () => ({
      isOpened: false,
      isLoading: false,
      hoverTimer: null,
      isDesktop: window.matchMedia('(hover: hover) and (pointer: fine)').matches || window.innerWidth >= 1366,

      init() {
        this.$watch('isOpened', (value) => {
          const header = document.querySelector('.b-header');
          const wrapper = document.querySelector('.b-header__wrapper');

          if (header && wrapper) {
            if (value) {
              header.classList.add('megamenu-open');
              wrapper.classList.add('has-megamenu-open');
            } else {
              header.classList.remove('megamenu-open');
              wrapper.classList.remove('has-megamenu-open');
            }
          }
        });
      },

      handleResize() {
        this.isDesktop = window.matchMedia('(hover: hover) and (pointer: fine)').matches || window.innerWidth >= 1366;
        if (!this.isDesktop) this.closeMegamenu();
      },

      // Mobile / click
      async toggleMegamenu() {
        if (this.isDesktop) return;
        try {
          this.isLoading = true;
          this.isOpened = !this.isOpened;
          if (this.isOpened) this.openMegamenu(); else this.closeMegamenu();
        } catch (e) { console.error('Error toggling megamenu:', e); }
        finally { this.isLoading = false; }
      },

      // Desktop / hover
      onEnterRoot(){ if (this.isDesktop) this.clearHoverTimer(); },
      onLeaveRoot(){ if (this.isDesktop) this.startHoverCloseTimer(); },
      onEnterButton(){ if (this.isDesktop) { this.clearHoverTimer(); this.openMegamenu(); } },
      onEnterPanel(){ if (this.isDesktop) this.clearHoverTimer(); },
      onLeavePanel(){ if (this.isDesktop) this.startHoverCloseTimer(); },

      startHoverCloseTimer() {
        this.clearHoverTimer();
        this.hoverTimer = setTimeout(() => this.closeMegamenu(), 120);
      },
      clearHoverTimer() {
        if (this.hoverTimer) { clearTimeout(this.hoverTimer); this.hoverTimer = null; }
      },

      openMegamenu() {
        this.isOpened = true;
        if (!this.isDesktop) document.body.classList.add('overflow-hidden');
      },
      closeMegamenu() {
        this.isOpened = false;
        document.body.classList.remove('overflow-hidden');
        this.clearHoverTimer();
      },
    }));
  });
</script>
